<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>VOL‑MEDIA DECKS v8 — Field of Stacks (HUD View, Grid Designer, Iso Controls)</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:none}
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#000;color:#fff;overflow:hidden}
  #canvas{width:100vw;height:100vh;display:block}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
(function(){
  function loadThree(next){
    if(window.THREE){ next(); return; }
    var CDNs=[
      'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js',
      'https://unpkg.com/three@0.152.2/build/three.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js'
    ];
    (function tryOne(i){
      if(i>=CDNs.length){ next(); return; }
      var s=document.createElement('script'); s.src=CDNs[i];
      s.onload=function(){ next(); };
      s.onerror=function(){ tryOne(i+1); };
      document.head.appendChild(s);
    })(0);
  }

  loadThree(function(){
    // ===== Helpers =====
    function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
    function now(){ return performance.now(); }

    // ===== CORE STATE =====
    var bpm=96;
    var energy=.35;
    var resonance=.45;
    var playing=false;
    var xf=0;

    // Grid designer state
    var GRID={ cols:4, maxCols:5, gapX:26, gapZ:26, snap:true };

    var padA, padB; // ambient pads

    var STATES={ gridOrder:['DECK_A','OVERLAP','DECK_B','CTRL_BPM','CTRL_ENERGY','CTRL_RES','CTRL_MIX'], cellW:18, cellH:18 };

    // ===== Scene =====
    var canvas=document.getElementById('canvas');
    var scene=new THREE.Scene(); scene.background=new THREE.Color(0x000000);
    var camera=new THREE.PerspectiveCamera(54, innerWidth/innerHeight, .1, 3000); camera.position.set(0,58,120); camera.lookAt(0,14,0);
    var renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:true}); renderer.setSize(innerWidth,innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,2));

    scene.add(new THREE.AmbientLight(0xfafcff,.22));
    var key=new THREE.PointLight(0x66ddff,1.4,780); key.position.set(0,80,160); scene.add(key);
    var warm=new THREE.PointLight(0xffaa66,1.0,640); warm.position.set(120,54,-80); scene.add(warm);
    var rim=new THREE.DirectionalLight(0xffffff,.55); rim.position.set(-110,130,-60); scene.add(rim);

    // ===== Sprites =====
    function sprite(text, scale){ if(scale==null) scale=7; var c=document.createElement('canvas'); c.width=512; c.height=256; var ctx=c.getContext('2d'); ctx.clearRect(0,0,512,256); ctx.fillStyle='#fff'; ctx.font='bold 64px Inter, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowColor='rgba(0,0,0,.6)'; ctx.shadowBlur=18; ctx.fillText(text,256,128); var tex=new THREE.CanvasTexture(c); var mat=new THREE.SpriteMaterial({map:tex, transparent:true, depthWrite:false}); var sp=new THREE.Sprite(mat); sp.scale.set(scale, scale*0.5, 1); sp.userData={ c:c, ctx:ctx }; return sp; }
    function setSprite(sp, text){ var c=sp.userData.c, ctx=sp.userData.ctx; ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#fff'; ctx.font='bold 64px Inter, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowColor='rgba(0,0,0,.6)'; ctx.shadowBlur=18; ctx.fillText(text,256,128); sp.material.map.needsUpdate=true; }

    // ===== Views & Dial =====
    var VIEWS=[
      {name:'FRONT',pos:[0,40,130]},
      {name:'ISO L',pos:[-95,46,88]},
      {name:'ISO R',pos:[95,46,88]},
      {name:'SIDE',pos:[0,40,-130]},
      {name:'TOP',pos:[0,150,0.01]}
    ];
    var viewIdx=0, orbit=false, orbitSpeed=10, tOrbit=0, dist=130;
    function applyView(){ var v=VIEWS[viewIdx%VIEWS.length]; camera.position.set(v.pos[0],v.pos[1],v.pos[2]); camera.lookAt(0,14,0); setSprite(viewDial.label, v.name); }

    // HUD Dial + Iso Buttons
    var HUD_LAYER=1;
    var viewDial={group:new THREE.Group(), ring:null, pins:[], label:sprite('',6), pos:{x:20,y:-10,z:-22}};
    function buildViewDial(){
      var r=8, n=VIEWS.length;
      var ringGeo=new THREE.RingGeometry(r-0.6,r+0.6,48);
      var ringMat=new THREE.MeshBasicMaterial({color:0x9ad7ff, transparent:true, opacity:.95, depthTest:false});
      viewDial.ring=new THREE.Mesh(ringGeo, ringMat); viewDial.ring.renderOrder=999; viewDial.ring.layers.set(HUD_LAYER); viewDial.group.add(viewDial.ring);
      viewDial.label.position.set(0,0.2,0); viewDial.label.material.depthTest=false; viewDial.label.renderOrder=1000; viewDial.label.layers.set(HUD_LAYER); viewDial.group.add(viewDial.label);
      for(var i=0;i<n;i++){ var a=(i/n)*Math.PI*2; var pin=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,1.8,12), new THREE.MeshBasicMaterial({color:0xffffff, depthTest:false})); pin.position.set(Math.cos(a)*r, 0, Math.sin(a)*r); pin.userData.idx=i; pin.renderOrder=1000; pin.layers.set(HUD_LAYER); viewDial.group.add(pin); viewDial.pins.push(pin); }
      // Extra iso preset buttons around the ring
      var isoBtns=[{name:'ISO L',idx:1,dx:-12,dz:0},{name:'ISO R',idx:2,dx:12,dz:0},{name:'TOP',idx:4,dx:0,dz:-12}];
      viewDial.iso=[];
      for(var k=0;k<isoBtns.length;k++){ var b=isoBtns[k]; var sp=sprite(b.name,5); sp.position.set(b.dx,0.2,b.dz); sp.material.depthTest=false; sp.renderOrder=1000; sp.layers.set(HUD_LAYER); sp.userData.idx=b.idx; viewDial.group.add(sp); viewDial.iso.push(sp); }
      try{ var saved=JSON.parse(localStorage.getItem('VMD6_HUDPOS')||'null'); if(saved && typeof saved.x==='number'){ viewDial.pos.x=saved.x; viewDial.pos.y=saved.y; viewDial.pos.z=saved.z; } }catch(e){}
      viewDial.group.position.set(viewDial.pos.x, viewDial.pos.y, viewDial.pos.z);
      camera.add(viewDial.group); scene.add(camera);
    }

    // ===== Data model =====
    var MAX_PLATES=28; var MAX_COLS=5;
    function mkPlate(color,op){ var g=new THREE.PlaneGeometry(12,12); var m=new THREE.MeshStandardMaterial({color:color,transparent:true,opacity:op,side:THREE.DoubleSide,depthWrite:false,roughness:.55,metalness:.08}); var mesh=new THREE.Mesh(g,m); mesh.rotation.x=-Math.PI/2; m.emissive=new THREE.Color(color); m.emissiveIntensity=.22; return mesh; }
    function mkHalo(){ var geo=new THREE.RingGeometry(6.2,6.8,48); var mat=new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:.85}); var h=new THREE.Mesh(geo,mat); h.rotation.x=-Math.PI/2; h.visible=false; return h; }

    var CRATES=[
      {id:'70s', name:'1970s', col:0xffa44d, voice:'tape'},
      {id:'80s', name:'1980s', col:0x59e0ff, voice:'fm'},
      {id:'00s', name:'2000s', col:0xffffff, voice:'supersaw'}
    ];

    var modules=[]; // {key,type,group,plates,halo,color,params,organizable}
    var decks={
      A:{color:0x00ff88, crate:CRATES[1], steps:16, root:110, scale:'minorPent', spacing:1.12, layers:16, size:1.0, seq:Array(32).fill(0), tune:Array(32).fill(0), phase:0, group:null, plates:[], halo:null},
      B:{color:0xff4488, crate:CRATES[2], steps:16, root:220, scale:'majorPent', spacing:1.12, layers:16, size:1.0, seq:Array(32).fill(0), tune:Array(32).fill(0), phase:0, group:null, plates:[], halo:null}
    };
    var overlap={color:0xffaa00, steps:16, spacing:1.12, layers:12, seq:Array(32).fill(0), tune:Array(32).fill(0), phase:0, group:null, plates:[], halo:null};

    function refreshDeck(which){ var d=decks[which]; var activeColor=new THREE.Color(d.color).lerp(new THREE.Color(0xffffff), 0.3*resonance); var baseScale=d.size*(1+0.06*energy); var EI=0.18+0.6*energy; var OP=0.3+0.6*energy; d.plates.forEach(function(p,i){ var vis=i<d.layers; p.visible=vis; if(!vis) return; p.position.y=i*d.spacing; p.scale.set(baseScale,1,baseScale); p.material.color.copy(activeColor); p.material.emissive.copy(new THREE.Color(d.color)); p.material.emissiveIntensity = EI*(0.95 - (i/Math.max(1,d.layers))*0.5); p.material.opacity = OP*(0.95 - (i/Math.max(1,d.layers))*0.4); }); }
    function refreshOverlap(){ var EI=.12+.5*energy; var OP=.18+.5*energy; for(var i=0;i<overlap.plates.length;i++){ var p=overlap.plates[i]; var vis=i<overlap.layers; p.visible=vis; if(!vis) continue; p.position.y=i*overlap.spacing; p.material.emissiveIntensity = EI*(0.95 - (i/Math.max(1,overlap.layers))*0.5); p.material.opacity = OP*(0.95 - (i/Math.max(1,overlap.layers))*0.4); } }

    function buildDeck(which){ var d=decks[which]; var g=new THREE.Group(); d.group=g; d.plates=[]; for(var i=0;i<MAX_PLATES;i++){ var p=mkPlate(d.color,.24); p.position.y=i*d.spacing; g.add(p); d.plates.push(p); } d.halo=mkHalo(); g.add(d.halo); modules.push({ key:'DECK_'+which, type:'deck', group:g, plates:d.plates, halo:d.halo, color:d.color, params:{ which:which }, organizable:true }); scene.add(g); refreshDeck(which); }
    function buildOverlap(){ var g=new THREE.Group(); overlap.group=g; overlap.plates=[]; for(var i=0;i<MAX_PLATES;i++){ var p=mkPlate(overlap.color,.16); p.position.y=i*overlap.spacing; g.add(p); overlap.plates.push(p); } overlap.halo=mkHalo(); g.add(overlap.halo); modules.push({ key:'OVERLAP', type:'overlap', group:g, plates:overlap.plates, halo:overlap.halo, color:overlap.color, params:{}, organizable:true }); scene.add(g); refreshOverlap(); }

    buildDeck('A'); buildDeck('B'); buildOverlap();

    // ===== Grid Designer / Organization =====
    var LINKS=[]; // array of [key1,key2]
    function addLink(k1,k2){ if(k1===k2) return; for(var i=0;i<LINKS.length;i++){ var L=LINKS[i]; if((L[0]===k1&&L[1]===k2)||(L[0]===k2&&L[1]===k1)) return; } LINKS.push([k1,k2]); }
    function clearLinks(){ LINKS.length=0; }

    function clusterOrder(keys){ // simple union-find via adjacency
      var adj={}; for(var i=0;i<keys.length;i++){ adj[keys[i]]=[]; }
      for(var j=0;j<LINKS.length;j++){ var a=LINKS[j][0], b=LINKS[j][1]; if(adj[a]) adj[a].push(b); if(adj[b]) adj[b].push(a); }
      var seen={}; var ordered=[];
      function dfs(k){ if(seen[k]) return; seen[k]=true; ordered.push(k); var arr=adj[k]||[]; for(var t=0;t<arr.length;t++) dfs(arr[t]); }
      for(var k=0;k<keys.length;k++){ var id=keys[k]; if(!seen[id]) dfs(id); }
      return ordered;
    }

    function layoutGrid(){
      GRID.cols=clamp(GRID.cols,1,GRID.maxCols);
      var org=modules.filter(function(m){return m.organizable;});
      var fixed=modules.filter(function(m){return !m.organizable;});
      // reorder organizables by clusters
      var keys=org.map(function(m){return m.key;});
      var order=clusterOrder(keys);
      org.sort(function(a,b){ return order.indexOf(a.key)-order.indexOf(b.key); });
      var list=org.concat(fixed);
      var cols=Math.min(GRID.maxCols, Math.max(1, GRID.cols));
      var gapX=GRID.gapX, gapZ=GRID.gapZ; var rows=Math.ceil(list.length/cols);
      var totalW=(cols-1)*gapX, totalZ=(rows-1)*gapZ; var x0=-totalW/2, z0=-totalZ/2;
      for(var i=0;i<list.length;i++){
        var r=Math.floor(i/cols), c=i%cols; var x=x0 + c*gapX; var z=z0 + r*gapZ;
        if(GRID.snap){ x=Math.round(x); z=Math.round(z); }
        list[i].group.position.set(x,0,z);
      }
    }

    // ===== Controls as stacks =====
    function mkControlStack(name,color, getter, setter, min, max){
      var g=new THREE.Group(); var N=16, plates=[]; for(var j=0;j<N;j++){ var p=mkPlate(color, 0.22); p.position.y=j*1.1; g.add(p); plates.push(p); }
      var tag=sprite(name,6); tag.position.set(0, N*1.1+2, 0); g.add(tag);
      var halo=mkHalo(); g.add(halo);
      var key='CTRL_'+name.toUpperCase();
      var mod={ key:key, type:'ctrl', group:g, plates:plates, halo:halo, color:color, params:{ getter:getter, setter:setter, min:min, max:max }, organizable:false };
      modules.push(mod); scene.add(g); refreshCtrl(mod); return mod;
    }
    function refreshCtrl(mod){ var getter=mod.params.getter, min=mod.params.min, max=mod.params.max; var v=clamp((getter()-min)/(max-min),0,1); var nOn=Math.round(v*mod.plates.length); mod.plates.forEach(function(p,idx){ var on=idx<nOn; p.material.opacity = on? 0.78 : 0.12; p.material.emissiveIntensity = on? 0.9 : 0.15; p.scale.set(1+(on?0.08:0),1,1+(on?0.08:0)); }); }

    mkControlStack('BPM',0x59e0ff, function(){return bpm;}, function(v){ bpm=clamp(Math.round(v),60,160); }, 60, 160);
    mkControlStack('ENERGY',0x00ff88, function(){return energy*100;}, function(v){ energy=clamp(v/100,0,1); }, 0, 100);
    mkControlStack('RES',0xffa44d, function(){return resonance*100;}, function(v){ resonance=clamp(v/100,0,1); }, 0, 100);
    mkControlStack('MIX',0xff4488, function(){return ((xf+1)/2)*100;}, function(v){ setXF((clamp(v,0,100)/100)*2-1); }, 0, 100);

    // ===== Grid HUD (universal designer) =====
    var gridHUD={group:new THREE.Group(), items:[]};
    function hudBtn(label, x, z, onTap){ var sp=sprite(label,5); sp.position.set(x,0.2,z); sp.material.depthTest=false; sp.renderOrder=1000; sp.layers.set(HUD_LAYER); sp.userData.tap=onTap; gridHUD.group.add(sp); gridHUD.items.push(sp); return sp; }
    function buildGridHUD(){
      // Cols - / +
      hudBtn('−COL', -24, 12, function(){ GRID.cols=clamp(GRID.cols-1,1,GRID.maxCols); layoutGrid(); });
      hudBtn('+COL', -12, 12, function(){ GRID.cols=clamp(GRID.cols+1,1,GRID.maxCols); layoutGrid(); });
      // Gap X / Gap Z adjust
      hudBtn('−GX', 0, 12, function(){ GRID.gapX=clamp(GRID.gapX-2,12,60); layoutGrid(); });
      hudBtn('+GX', 12, 12, function(){ GRID.gapX=clamp(GRID.gapX+2,12,80); layoutGrid(); });
      hudBtn('−GZ', 24, 12, function(){ GRID.gapZ=clamp(GRID.gapZ-2,12,60); layoutGrid(); });
      hudBtn('+GZ', 36, 12, function(){ GRID.gapZ=clamp(GRID.gapZ+2,12,80); layoutGrid(); });
      // Snap toggle
      hudBtn('SNAP', 24, -12, function(){ GRID.snap=!GRID.snap; layoutGrid(); });
      // Link mode: tap two stacks to keep adjacent
      hudBtn('LINK', -24, -12, function(){ linkMode.active=!linkMode.active; linkMode.sel=null; });
      // Clear links
      hudBtn('CLR', -12, -12, function(){ clearLinks(); layoutGrid(); });
      gridHUD.group.position.set(-22,-6,-20); // top-left relative to screen
      gridHUD.group.layers.set(HUD_LAYER);
      camera.add(gridHUD.group); scene.add(camera);
    }

    // ===== Interaction =====
    var ray=new THREE.Raycaster(); var v2=new THREE.Vector2();
    function pick(x,y,objects, layer){ if(layer==null) layer=0; v2.x=(x/innerWidth)*2-1; v2.y=-(y/innerHeight)*2+1; ray.setFromCamera(v2,camera); ray.layers.set(layer); return ray.intersectObjects(objects,true); }

    // View HUD
    function handleViewHUDDown(e){ var hits=pick(e.clientX,e.clientY,[viewDial.group], HUD_LAYER); if(!hits.length) return false; var o=hits[0].object; if(o.userData && o.userData.idx!=null){ viewIdx=o.userData.idx; applyView(); return true; } if(o===viewDial.ring){ viewIdx=(viewIdx+1)%VIEWS.length; applyView(); return true; } return false; }

    // Grid HUD
    function handleGridHUDDown(e){ var hits=pick(e.clientX,e.clientY,[gridHUD.group], HUD_LAYER); if(!hits.length) return false; var o=hits[0].object; if(o.userData && typeof o.userData.tap==='function'){ o.userData.tap(); return true; } return false; }

    // Linking mode
    var linkMode={active:false, sel:null};

    canvas.addEventListener('pointerdown', function(e){
      if(handleViewHUDDown(e)) return;
      if(handleGridHUDDown(e)) return;
      // Organizable stack selection / linking
      var orgMeshes=[]; for(var i=0;i<modules.length;i++){ if(modules[i].organizable){ orgMeshes=orgMeshes.concat(modules[i].plates); } }
      var hits=pick(e.clientX,e.clientY, orgMeshes, 0);
      if(hits.length){
        var mesh=hits[0].object; var parent=mesh.parent; var mod=null; for(var m=0;m<modules.length;m++){ if(modules[m].group===parent){ mod=modules[m]; break; } }
        if(mod && linkMode.active){ if(!linkMode.sel){ linkMode.sel=mod.key; } else { addLink(linkMode.sel, mod.key); linkMode.sel=null; layoutGrid(); } }
      }
    });

    // Plate toggles (music)
    function showHalo(mod, layerY){ mod.halo.visible=true; mod.halo.position.y=layerY+0.01; clearTimeout(mod.halo._id); mod.halo._id=setTimeout(function(){ mod.halo.visible=false; }, 240); }
    function pulse(p){ p.material.emissiveIntensity=1.0; p.scale.set(p.scale.x*1.15,1,p.scale.z*1.15); setTimeout(function(){ p.scale.set(1,1,1); p.material.emissiveIntensity=.22+0.6*energy; },110); }

    canvas.addEventListener('pointerdown',function(e){
      // musical tap on deck/overlap plates
      var allPlates=[].concat(decks.A.plates,decks.B.plates,overlap.plates);
      var hits=pick(e.clientX,e.clientY, allPlates, 0);
      if(!hits.length) return; var mesh=hits[0].object; var parent=mesh.parent; var mod=null; for(var ii=0;ii<modules.length;ii++){ if(modules[ii].group===parent){ mod=modules[ii]; break; } }
      if(!mod) return; var idx=mod.plates.indexOf(mesh); if(idx<0) return;
      if(mod.type==='deck'){ var which=mod.params.which; var d=decks[which]; var step=idx % d.steps; d.seq[step]=d.seq[step]?0:1; showHalo(mod, mesh.position.y); pulse(mesh); }
      if(mod.type==='overlap'){ var step2=idx % overlap.steps; overlap.seq[step2]=overlap.seq[step2]?0:1; showHalo(mod, mesh.position.y); pulse(mesh); }
    });

    // ===== Audio =====
    var AC, master, voices={A:null,B:null}, padBus;
    function audioInit(){ if(AC) return; var C=window.AudioContext||window.webkitAudioContext; AC=new C(); master=AC.createGain(); master.gain.value=.22; master.connect(AC.destination); padBus=AC.createGain(); padBus.gain.value=.08; padBus.connect(master); voices.A=buildVoice(decks.A.crate.voice); voices.B=buildVoice(decks.B.crate.voice); buildEnoPads(); }
    function buildVoice(kind){ var out=AC.createGain(); out.connect(master); var env=AC.createGain(); env.gain.value=0; var filt=AC.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=1400; filt.Q.value=.7; filt.connect(env).connect(out); function osc(type,det){ if(det==null) det=0; var o=AC.createOscillator(); o.type=type; o.detune.value=det; o.start(); o.connect(filt); return o; } var parts={ env:env, filt:filt, out:out }; if(kind==='tape'){ parts.o1=osc('sawtooth',-4); parts.o2=osc('triangle',+4);} else if(kind==='fm'){ parts.o1=osc('square',0); parts.o2=osc('square',+7);} else { parts.o1=osc('sawtooth',-9); parts.o2=osc('sawtooth',+9);} return parts; }
    function setFreq(parts,f){ if(parts.o1) parts.o1.frequency.setTargetAtTime(f,AC.currentTime,.02); if(parts.o2) parts.o2.frequency.setTargetAtTime(f*1.001,AC.currentTime,.02); }
    function trigger(env,level,dur){ if(level==null) level=.6; if(dur==null) dur=.22; var t=AC.currentTime; env.gain.cancelScheduledValues(t); env.gain.setValueAtTime(env.gain.value,t); env.gain.linearRampToValueAtTime(level,t+0.01); env.gain.exponentialRampToValueAtTime(0.0001,t+dur); }
    function setFilter(parts,cut,q){ parts.filt.frequency.setTargetAtTime(cut,AC.currentTime,.02); parts.filt.Q.setTargetAtTime(q,AC.currentTime,.02); }
    function scaleFreq(scale,root,degree){ var tbl={minorPent:[0,3,5,7,10],majorPent:[0,2,4,7,9],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,5,7,8]}; var arr=tbl[scale]||tbl.minorPent; var semi=arr[degree%arr.length]; return root*Math.pow(2,semi/12) }
    function deckLevel(which){ var base=(which==='A'? (1-(xf+1)/2) : ((xf+1)/2)); var sz=(which==='A'?decks.A.size:decks.B.size); return base*sz; }
    function buildEnoPads(){ var mkPad=function(rootHz){ var g=AC.createGain(); g.gain.value=0.02; var f=AC.createBiquadFilter(); f.type='lowpass'; f.frequency.value=500; f.Q.value=0.4; var o1=AC.createOscillator(); o1.type='sine'; o1.frequency.value=rootHz; var o2=AC.createOscillator(); o2.type='triangle'; o2.frequency.value=rootHz*2; var lfo=AC.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.03+Math.random()*0.04; var lfg=AC.createGain(); lfg.gain.value=80; lfo.connect(lfg).connect(f.frequency); o1.connect(f); o2.connect(f); f.connect(g).connect(padBus); o1.start(); o2.start(); lfo.start(); return { g:g, f:f, o1:o1, o2:o2 }; }; padA=mkPad(110); padB=mkPad(146.83); }

    function startClock(){ var last=now(); (function loop(){ if(playing && AC && AC.state==='running'){ var beat=60000/bpm; var step=beat/4; var t=now(); if(t-last>=step){ last+=step; tick(); } } requestAnimationFrame(loop); })(); }
    function tick(){ ['A','B'].forEach(function(which){ var d=decks[which]; d.phase=(d.phase+1)%d.steps; var idx=d.phase; if(d.seq[idx]){ var f=scaleFreq(d.scale,d.root,idx); var tuned=Math.max(1,f); var v=(which==='A')?voices.A:voices.B; setFreq(v,tuned); setFilter(v, 900+2400*energy, .7+5*resonance); trigger(v.env, .22 + .5*deckLevel(which), .14 + .12*resonance); var plate=d.plates[idx % Math.max(1,d.layers)]; if(plate){ showHalo(modules.find(function(m){return m.key==='DECK_'+which;}), plate.position.y); pulse(plate); } } });
      overlap.phase=(overlap.phase+1)%overlap.steps; if(overlap.seq[overlap.phase]){ var p=overlap.plates[overlap.phase%Math.max(1,overlap.layers)]; if(p){ showHalo(modules.find(function(m){return m.key==='OVERLAP';}), p.position.y); } }
    }

    function setXF(x){ xf=clamp(x,-1,1); decks.A.layers = clamp(Math.round(10+((1-x)/2)*18),6,MAX_PLATES); decks.B.layers = clamp(Math.round(10+((1+x)/2)*18),6,MAX_PLATES); refreshDeck('A'); refreshDeck('B'); }
    function updateCam(){ if(orbit){ tOrbit+=0.0012*orbitSpeed*(60/bpm); camera.position.x=Math.sin(tOrbit)*dist; camera.position.z=Math.cos(tOrbit)*dist; camera.position.y=58; camera.lookAt(0,14,0); } }

    addEventListener('resize',function(){ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); layoutGrid(); });

    var primed=false; canvas.addEventListener('pointerdown', function(){ if(!primed){ audioInit(); if(AC.state!=='running'){ AC.resume && AC.resume(); } playing=true; primed=true; startClock(); } }, {once:true});
    addEventListener('keydown',function(e){ if(e.key==='o'){ orbit=!orbit; } if(e.key==='v'){ viewIdx=(viewIdx+1)%VIEWS.length; applyView(); } if(e.key==='['){ GRID.cols=clamp(GRID.cols-1,1,GRID.maxCols); layoutGrid(); } if(e.key===']'){ GRID.cols=clamp(GRID.cols+1,1,GRID.maxCols); layoutGrid(); } });

    // Build
    buildViewDial(); applyView(); buildGridHUD(); layoutGrid(); refreshCtrl(modules.find(function(m){return m.key==='CTRL_BPM';}));

    (function animate(){ requestAnimationFrame(animate); updateCam(); modules.filter(function(m){return m.type==='ctrl';}).forEach(refreshCtrl); renderer.render(scene,camera); })();

    // ===== Tests =====
    (function runTests(){
      var results=[]; function ok(name,cond){ results.push({test:name, pass:!!cond}); }
      try{ ok('T1 STATES defined early', typeof STATES==='object' && STATES.cellW>0); }catch(e){ ok('T1 STATES defined early', false); }
      try{ ok('T2 resonance defined', typeof resonance==='number'); }catch(e){ ok('T2 resonance defined', false); }
      try{ layoutGrid(); ok('T3 layoutGrid callable', true); }catch(e){ ok('T3 layoutGrid callable', false); }
      try{ ok('T4 view dial present', !!viewDial.group && !!viewDial.ring); }catch(e){ ok('T4 view dial present', false); }
      try{ var rows={}; modules.forEach(function(m){ var z=Math.round(m.group.position.z); rows[z]=(rows[z]||0)+1; }); ok('T5 max 5 per row', Object.values(rows).every(function(n){return n<=5;})); }catch(e){ ok('T5 max 5 per row', false); }
      try{ ok('T6 HUD attached to camera', viewDial.group.parent===camera); }catch(e){ ok('T6 HUD attached to camera', false); }
      try{ ok('T7 HUD depthTest disabled', viewDial.ring.material.depthTest===false); }catch(e){ ok('T7 HUD depthTest disabled', false); }
      try{ ok('T8 HUD separate layer', viewDial.ring.layers.mask!==0); }catch(e){ ok('T8 HUD separate layer', false); }
      try{ ok('T9 gaps adjustable', GRID.gapX>=12 && GRID.gapZ>=12); }catch(e){ ok('T9 gaps adjustable', false); }
      try{ ok('T10 iso buttons exist', viewDial.iso && viewDial.iso.length>=2); }catch(e){ ok('T10 iso buttons exist', false); }
      try{ GRID.cols=5; layoutGrid(); var maxPerRow={}; modules.forEach(function(m){ var z=Math.round(m.group.position.z); maxPerRow[z]=(maxPerRow[z]||0)+1; }); ok('T11 <=5 cols enforced', Object.values(maxPerRow).every(function(n){return n<=5;})); }catch(e){ ok('T11 <=5 cols enforced', false); }
      console.table(results);
    })();

  });
})();
</script>
</body>
</html>
